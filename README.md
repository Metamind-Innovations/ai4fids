# AI4FIDS

A collection of modules that generate protocol-specific flow statistics and perform AI-based intrusion detection. 

## Data folders
To ensure that AI4FIDS works properly, create the following folders:
- `unlabelled-pcap`: This folder contains pcap files that need to be edited first in order to be processed by the AppFlowMeter modules. This folder is used only by the `utils/pcap_labelling.py` script, and in most cases you will not need it.
- `labelled-pcap`: This folder contains the pcap files that are ready to be processed by the AppFlowMeter modules. In most cases, you will need to put new pcaps into this folder in order to generate the corresponding flows.
- `unlabelled-csv`: This folder contains the output of the AppFlowMeter modules. For each pcap inside the `labelled-pcap` and each AppFlowMeter module, a corresponding csv is expected in the `unlabelled-csv` folder. It should be noted that the CSVs inside that folder are unlabelled, hence they need to be processed so that each flow to be classified as benign or as a specific attack.
- `labelled-csv`: This folder contains the output of the `utils/flow_labelling.py` script, i.e. the labelled CSVs, where each flow is associated with a specific class. The `utils/flow_labelling.py` reads the CSVs located in the `unlabelled-csv` folder.
- `models`: This folder contains the model artifacts that will be used for inference. Specifically, it should contain a `model.h5` file (which is the trained model), the model scaler `sclaer.joblib`, and the label encoder `label_encoder.joblib`.
- `output`: It stores the security events generated by the inference engine.

## Installation

1. Clone the repo:
    ```shell
    git clone git@github.com:Metamind-Innovations/ai4fids.git
    ```

2. Create a Python environment (make sure the `python-venv` package is already installed):
    ```shell
    python3 -m venv venv
    ```

3. Activate the environment and install the Python packages:
    ```shell
    $ cd ai4fids
    $ source ./venv/bin/activate
    $ (venv) pip install -r requirements.txt
    ```

4. Install PcapPlusPlus with the following commands (check if a newer release of PcapPlusPlus is available):
    ```shell
    $ wget https://github.com/seladb/PcapPlusPlus/releases/download/v24.09/pcapplusplus-24.09-ubuntu-24.04-gcc-13.2.0-x86_64.tar.gz
    $ tar xzvf pcapplusplus-24.09-ubuntu-24.04-gcc-13.2.0-x86_64.tar.gz
    $ rm pcapplusplus-24.09-ubuntu-24.04-gcc-13.2.0-x86_64.tar.gz
    $ sudo cp ./pcapplusplus-24.09-ubuntu-24.04-gcc-13.2.0-x86_64/bin/PcapSplitter /usr/bin
    $ PcapSplitter -h
    $ rm -rf ./pcapplusplus-24.09-ubuntu-24.04-gcc-13.2.0-x86_64

    ```

5. Prepare prerequisites for traffic capture and CICFlowMeter
    ```shell
    $ sudo apt install default-jre wireshark-common libpcap-dev
    $ cd ./cicflowmeter/lib && sudo mvn install:install-file -Dfile=jnetpcap-1.4.r1425-1g.jar -DgroupId=org.jnetpcap -DartifactId=jnetpcap -Dversion=1.4.1 -Dpackaging=jar
    ```

6. Make sure you can run tcpdump without root privileges (https://medium.com/@hafizfarhad/fix-tcpdump-eth0-you-dont-have-permission-to-perform-this-capture-on-that-device-3941395be45c)

## Configuration
The two core modules of ai4fids are `appflowmeter` and `inference_engine.inference`. These should be configures seperately
Configure `appflowmeter` by creating a `conf/appflow_config.json` file and filling it accordingly (check bellow the template).

```json
{
    "General": {
        "FLOW_TIMEOUT_SECONDS": 15,
        "OPERATION_MODE": "ONLINE",
        "OFFLINE_PCAP_FILES": [],
        "OUTPUT_KAFKA": false,
        "ONLINE_CAPTURE_INTERFACE": "lo",
        "ONLINE_CAPTURE_DURATION": "15s",
        "ONLINE_CAPTURE_PORTS_WHITELIST": [],
        "FLOW_MODULES": ["CICFLOWMETER"]
    },
    "Labelling": {
        "INPUT_CSV_FILES": [],
        "INPUT_PCAP_FILES": []
    }
}

```
| Parameter | Description | Allowed Values  | 
|-----------|-------------|-----------------| 
| `General.FLOW_TIMEOUT_SECONDS` | The flow timeout, i.e. the maxium duration of a flow. | Integer > 0 |
| `General.OPERATION_MODE`  | `ONLINE` means that the AppFlowMeter captures live data from a specified interface. `OFFLINE` mode means that the AppFlowMeter reads the pcaps included in the `labelled-csv` folder.  | Enum[`ONLINE`, `OFFLINE`]  |
| `General.OFFLINE_PCAP_FILES`  |  Specify the names of the pcap files that the AppFlowMeter should process (relevant to the `labelled-pcap` folder). Leave it empty, if the AppFlowMeter should read all the files inside the `labelled-pcap` folder. |  List of strings |
| `General.ONLINE_CAPTURE_INTERFACE` | When `ONLINE` is set, it specifies the network interface used to capture live traffic. | String |
| `General.ONLINE_CAPTURE_DURATION` | When `ONLINE` is set, it specifies the duration of the live traffic capture, in seconds. Each `ONLINE_CAPTURE_DURATION` seconds, the traffic capture is stopped and the pcap is delivered to the AppFlowMeter modules. | String (e.g., `10s`) |
| `General.ONLINE_CAPTURE_PORTS_WHITELIST` | When `ONLINE` is set, it specifies the TCP ports that should be whitelisted by `tcpdump`, aiming to reduce the amount of traffic that AppFlowMeter modules will proccess. | List of integers |
| `General.FLOW_MODULES` | Specifies the AppFlowMeter modules that should be used when running AppFlowMeter. | Enum[`OCPPFLOWMETER`, `CICFLOWMETER`, `KNXFLOWMETER`]. Only two modules are allowed at the same time, and only `CICFLOWMETER` can co-exist with other modules. |
| `Labelling.INPUT_CSV_FILES`  |  Optionally, you can specify which CSVs the `utils/flow_labelling.py` should process from the `unlabelled-csv` folder. If empty, all the CSVs inside that folder will be proccessed. |  List of strings |
| `Labelling.INPUT_PCAP_FILES` |  Optionally, you can specify which PCAPs the `utils/pcap_labelling.py` should process from the `unlabelled-pcap` folder. If empty, all the PCAPs inside that folder will be proccessed. |  List of strings |
| `Labelling.Malicious_IP`     |  A list of the IP addresses that should be considered malicious. Depending on the CSV that is processed by `utils/flow_labelling.py`, the corresponding label is applied automatically if one of the IP addresses of the list is present in the flow. | List of strings |

Configure `inference_engine.inference` by creating a `conf/inf_config.json` file and filling it accordingly (check bellow the template).
```json
{
    "mode": "online",
    "paths": {
      "offline": "test/dummy_flow/flow.csv",
      "online": "unlabelled-csv"
    },
    "scaler_path": "models/scaler.joblib",
    "encoder_path": "models/label_encoder.joblib",
    "model_path": "models/model.h5",
    "output_dir": "output",
    "features_to_drop": ["Flow ID","Src IP","Src Port","Dst IP", "Dst Port", "Protocol", "Label", "Timestamp"],
    "label_keyword": "Label",
    "kafka": {
        "enabled": false,
        "brokers": "ai4fids.kafka.com:9093",
        "ca_cert": "kafka_certs/CARoot.pem",
        "cert_file": "kafka_certs/certificate.pem",
        "key_file": "kafka_certs/RSAkey.pem",
        "password": "***********",
        "topic": "ai4fids.events"
    }
}
```

| Parameter | Description | Allowed Values  | 
|-----------|-------------|-----------------| 
| `mode` | `online` means that AI4FIDS is performing inference from live flows. `offline` means that AI4FIDS reads pre-saved flows and classifies them.  | Enum[`online`, `offline`] |
| `paths.offline`  | Indicates the path with the pre-saved flows for offline operation.  | String  |
| `paths.online`  |  Indicates the path with the live flows for online operation. Default is `unlabelled-csv`. It is suggested to not modify the default path |  String |
| `scaler_path` | Path to scaler. Scaler should be a `.joblib` file. | String |
| `encoder_path` | Path to label encoder. Should be a `.joblib` file | String |
| `model_path` | Path to trained model. | String |
| `output_dir` | Path to output directory. | String |
| `features_to_drop`  |  The features that should be excluded from the dataset |  List of strings |
| `label_keyword` |  The keyword of the label as appears in the columns of the flows .csv file |  String |
| `kafka.enabled`     | Enable message produciton to kfka topic | Boolean |
| `kafka.*`     | All kafka-related configuration (apart from `kafka.enabled`) are self-explenatory | String |

## Execution

AI4FIDS uses two core modules: i) the `appflowmeter`, which sniffs traffic on a given interface and generates PCAP files and network flows into CSV format, and ii) the `inference_engine.inference`, which reads the generated flows and performs inference, i.e., identifies malicious flows by using the pre-trained models.

1. Create the `labelled-pcap` and populate it with your PCAPs.

2. Make sure that the configuration files are tailored to your needs.

3. Run the inference engine as: 
    ```shell
    (venv) python -m inference_engine.inference
    ```

3. Open a new terminal and run the `appflowmeter`: 
    ```shell
    (venv) python -m appflowmeter
    ```

 These modules will run indefinitely. Press Ctrl+Z to terminate them. When finished, the unlabelled flows should be in the `unlabelled-csv` folder. If you want to run the automatic labelling script, just run the `utils/flow_labelling.py`:

```shell
(venv) python utils/flow_labelling.py
```

The labelled CSVs should be in the `labelled-csv` folder, and the `output` should contain the security events in JSON format.


